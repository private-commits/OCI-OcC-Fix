name: OCI Instance Retry

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  retry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Write OCI config
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/private_key.pem
          chmod 600 ~/.oci/private_key.pem
          cat > ./config << OCIEOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_KEY_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_ID }}
          region=${{ secrets.OCI_REGION }}
          key_file=${{ github.workspace }}/oci_key.pem
          OCIEOF
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ${{ github.workspace }}/oci_key.pem
          chmod 600 ${{ github.workspace }}/oci_key.pem

      - name: Write configuration.ini
        run: |
          cat > ./configuration.ini << INIEOF
          [DEFAULT]
          version = 2.1.3

          [OCI]
          image_id = ${{ secrets.OCI_IMAGE_ID }}
          availability_domains = ["llkX:UK-LONDON-1-AD-1","llkX:UK-LONDON-1-AD-2","llkX:UK-LONDON-1-AD-3"]
          compartment_id = ${{ secrets.OCI_COMPARTMENT_ID }}
          subnet_id = ${{ secrets.OCI_SUBNET_ID }}
          boot_volume_id = xxxx

          [Instance]
          display_name = OCI-ARM-01
          ssh_keys = ${{ secrets.OCI_SSH_PUBLIC_KEY }}
          boot_volume_size = 50

          [Telegram]
          bot_token = xxxx
          uid = xxxx

          [Machine]
          type = ARM
          shape = VM.Standard.A1.Flex
          ocpus = 4
          memory = 24

          [Retry]
          min_interval = 1
          max_interval = 60
          initial_retry_interval = 1
          backoff_factor = 1.5

          [Logging]
          log_level = INFO
          INIEOF

      - name: Run bot (single attempt)
        run: python3 bot.py
